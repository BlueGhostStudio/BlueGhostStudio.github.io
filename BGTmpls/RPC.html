<pf-RPC>
    <script data-fn="load" data-args="relPath, nextLoad">
        window.rpc = this;
        this.initRPC();
        compile($('<pf-connections id="RPCCONN" data-global></pf-connections>'));
        nextLoad();
    </script>

    <script data-fn="enablePingpong">
        RPCCONN.on("connected", () => {
            if (this.pingTimeoutID !== undefined)
                clearTimeout(this.pingTimeoutID);
            if (this.pingIntervalID !== undefined)
                clearTimeout(this.pingIntervalID);

            this.ping();
        });
        RPCCONN.on("disconnected", () => {
            if (this.pingTimeoutID !== undefined)
                clearTimeout(this.pingTimeoutID);
            if (this.pingIntervalID !== undefined)
                clearTimeout(this.pingIntervalID);
            rpc.connect();
        });
    </script>

    <script data-fn="ping">
        this.pingTimeoutID = setTimeout(() => {
            rpc.connect();
        }, 2000);
        rpc.asyncCall("fake", "ping").then(null, () => {
            clearTimeout(this.pingTimeoutID);
            RPCCONN.emit("pong");
            this.pingIntervalID = setTimeout(() => {
                RPCCONN.emit("ping");
                this.ping();
            }, 2000);
        });
    </script>

    <script data-fn="initRPC">
        this.__rpc__ = new RPC();

        this.__rpc__.onConnected = () => {
            RPCCONN.emit("connected");
        }

        this.__rpc__.onDisconnected = () => {
            RPCCONN.emit("disconnected");
        }

        this.__rpc__.onCalling = (obj, method, args, mID) => {
            RPCCONN.emit("calling", [obj, method, args, mID]);
        }

        this.__rpc__.onReturn = (mID) => {
            RPCCONN.emit("return", [mID]);
        }

        this.__rpc__.onRemoteSignal = (obj, sig, args) => {
            RPCCONN.emit("remoteSignal", [obj, sig, args]);
        }
        /*this.__rpc__.onConnected = (function () {
            console.log("---- this.__rpc__.onConnected ----", this.onConnected);
            if (this.onConnected)
                this.onConnected();
        }).bind(this);

        this.__rpc__.onDisconnected = (function () {
            if (this.onDisconnected)
                this.onDisconnected();
        }).bind(this);

        this.__rpc__.onCalling = (function (obj, method, args, mID) {
            if (this.onCalling)
                this.onCalling(obj, method, args, mID);
        }).bind(this);

        this.__rpc__.onReturn = (function (mID) {
            if (this.onReturn)
                this.onReturn(mID);
        }).bind(this);

        this.__rpc__.onRemoteSignal = (function (obj, sig, args) {
            this.$.trigger("remoteSignal", [obj, sig, args]);
        }).bind(this);*/

        this.call = this.__rpc__.call.bind(this.__rpc__);
        this.asyncCall = this.__rpc__.asyncCall.bind(this.__rpc__);
    </script>

    <script data-fn="onRemoteSignal" data-args="cb">
        this.$.on("remoteSignal", cb);
    </script>

    <script data-fn="connect" data-args="url, port">
        if (url !== undefined)
            this.__rpc__.url = url;
        if (port !== undefined)
            this.__rpc__.port = port;
        this.__rpc__.connectToHost();
    </script>

    <script data-fn="close">
        this.__rpc__.close();
    </script>

    <script data-fn="state">
        return this.__rpc__.ws ? this.__rpc__.ws.readyState : -1;
    </script>
</pf-RPC>
