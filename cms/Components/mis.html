<pf-package>
    <script data-fn="load" data-args="relPath, nextLoad">
        nextLoad();
    </script>

    <pf-extend-tmpl data-ft="cms::img::src">
        <pf-data data-fn="IMGSRC::opt" data-object>
            <pf-data data-fn="fallbackLogo" data-js><script>
                    return this.$.attr("data-fallbacklogo") !== undefined;
            </script></pf-data>
        </pf-data>

        <script data-fn="getSrc" data-args="src, lookupFallbackLogo">
            var backtrack = this.$.attr("data-backtrack") !== undefined;
            var pm;
            if (backtrack)
                pm = CMS.backtrackNode(undefined, src).then((ret) => {
                    return CMS.node(ret.target.id);
                });
            else
                pm = CMS.node(src);

            return pm.then((ret) => {
                if (ret.type === 'R'
                    && ['png', 'jpg', 'gif'].includes(ret.contentType)) {
                    var content = ret.content;
                    if (/^link:/.test(content))
                        return Promise.resolve(content.substring(5));
                    else
                        return CMS.mediaUrl(content.substring(4))
                            .then((ret) => {
                                return Promise.resolve(ret);
                            }, (ret) => {
                                console.log("error", ret);
                                return Promise.reject();
                            });
                }
            }, (ret) => {
                if (this.__DATA__["IMGSRC::opt"].fallbackLogo
                    && !lookupFallbackLogo
                    && CMS.__DATA__.config.logo)
                    return this.getSrc(CMS.__DATA__.config.logo, true);
                else {
                    console.log("error", ret);
                    return Promise.reject();
                }
            });
        </script>

        <script data-fn="constructor">
            var src = this.$.attr("data-src");

            if (src && src.length > 0)
                this.load(src);
        </script>
    </pf-extend-tmpl>

    <cms-img-tmpl data-ft="cms::img" data-fra="cms-img" data-tagName="img">
        <pf-extend data-fr="cms::img::src"></pf-extend>

        <script data-fn="load" data-args="src">
            return this.getSrc(src).then((ret) => {
                this.$.attr("src", ret);
            });
        </script>

        <!-- <script data-fn="constructor">
            var src = this.$.attr("src");

            CMSCONN.on("currentNodeChanged", () => {
                this.getSrc(this.src).then((ret) => {
                    this.$.attr("src", ret);
                });
            }, this);
        </script> -->
    </cms-img-tmpl>

    <div data-ft="cms::img::div" class="cms_img_div" data-fra="cms-img-div" data-tagName="div">
        <pf-extend data-fr="cms::img::src"></pf-extend>

        <script data-fn="load" data-args="src">
            return this.getSrc(src).then((ret) => {
                this.$.css("--bg-img-src", `url("${ret}")`);
            });
        </script>
        <!-- <script data-fn="constructor">
            this.src = this.$.attr("data-src");

            CMSCONN.on("currentNodeChanged", () => {
                this.getSrc(this.src).then((ret) => {
                    this.$.css("--bg-img-src", 'url("' + ret + '")');
                });
            }, this);
        </script> -->
    </div>

    <pf-text data-ft="cms::siteTitle"
             data-fra="cms-site-title"
             data-tagName="pf-text">
        <script data-fn="constructor">
            this.text(CMS.__DATA__.config.siteTitle);
        </script>
    </pf-text>

    <pf-container class="pluginsContainer"
                  data-ft="cms::plugins::container"
                  data-fra="cms-plugins-container"
                  data-fns="plugins::root"
                  data-tagname="pf-container">
        <pf-data data-fn="currentDirID" data-number>-1</pf-data>
        <pf-data data-fn="pluginsID" data-number>-1</pf-data>

        <script data-fn="loadPlugins" data-args="pluginsID">
            if (pluginsID === undefined)
                pluginsID = this.__DATA__.pluginsID;

            return CMS.node(pluginsID).then((ret) => {
                this.empty();
                this.__DATA__.pluginsID = ret.id;
                return contentGenerate[ret.contentType](ret.content, this);
            });
        </script>

        <script data-fn="load">
            let loadPromise = new Promise((resolve, reject) => {
                if (this.__DATA__.currentDirID === CMS.__DATA__.current.dirID)      // 如果内容目录未改变
                    resolve();
                else {
                    this.__DATA__.currentDirID = CMS.__DATA__.current.dirID;

                    CMS.backtrackNode(this.__DATA__.currentDirID, "site/plugins")   // 回溯
                        .then((ret) => {                                            // 回溯成功
                            if (this.__DATA__.pluginsID === ret.target.id)          // 如果插件已被加载
                                resolve();               // 直接返回
                            else {
                                this.loadPlugins(ret.target.id).then(() => {
                                    resolve();
                                });
                            }
                        }, (ret) => {                                               // 回溯失败
                            this.__DATA__.currentDirID = -1;
                            this.__DATA__.pluginsID = -1;
                            this.empty();
                            reject();
                        });
                }
            });

            return loadPromise.then(() => {
                CMSCONN.emit("pluginsRefresh");
            });
        </script>

        <script data-fn="constructor">
            CMSCONN.on("contentUpdated", (args) => {
                if (this.__DATA__.pluginsID == args[0]) {
                    this.loadPlugins().then(() => {
                        CMSCONN.emit("pluginsRefresh");
                    });
                }
            }, this);
        </script>
    </pf-container>

    <pf-extend-tmpl data-ft="cms::plugin::common">
        <pf-data data-fn="scenes" data-object>
            <pf-data data-fn="home" data-js><script>
                    return this.$.attr("data-home") !== undefined;
            </script></pf-data>
            <pf-data data-fn="dir" data-js><script>
                    return this.$.attr("data-dir") !== undefined;
            </script></pf-data>
            <pf-data data-fn="content" data-js><script>
                    return this.$.attr("data-content") !== undefined;
            </script></pf-data>
        </pf-data>

        <script data-fn="constructor">
            if (this.__DATA__.initial) {
                if (this.__DATA__.initial.home) {
                    this.__DATA__.scenes.home = true;
                    this.$.attr("data-home", "");
                }
                if (this.__DATA__.initial.dir) {
                    this.__DATA__.scenes.dir = true;
                    this.$.ttr("data-dir", "");
                }
                if (this.__DATA__.initial.content) {
                    this.__DATA__.scenes.content = true;
                    this.$.attr("data-content", "");
                }

                if (this.__DATA__.initial.title)
                    this.$.attr("title", this.__DATA__.initial.title);
            }

            CMSCONN.on("pluginsRefresh", () => {
                if ((CMS.__DATA__.current.type === 'H' && this.__DATA__.scenes.home) ||
                     (CMS.__DATA__.current.type === 'D' && this.__DATA__.scenes.dir) ||
                     (CMS.__DATA__.current.type === 'C' && this.__DATA__.scenes.content)) {
                    if (typeof this.refresh === 'function')
                        this.refresh();
                } else if (typeof this.leave === 'function')
                    this.leave();
            }, this);
        </script>
    </pf-extend-tmpl>
</pf-package>

