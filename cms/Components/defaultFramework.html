<pf-package>
    <script data-fn="load" data-args="relPath, nextLoad">
        nextLoad();
    </script>

    <pf-body data-ft="cms::default::framework" data-connected data-tagName="body">
        <cms-style data-fn="style_framework"></cms-style>
        <cms-style data-fn="style_page"></cms-style>
        <cms-style data-fn="style_colorScheme"></cms-style>

        <div id="pingpong" data-fi="true"></div>

        <pf-page data-fn="page">
            <header data-fw="true">
                <cms-img id="logo" src="/site/logo"></cms-img>
                <cms-site-title id="siteTitle"></cms-site-title>
                <cms-nav id="mainNav" data-path="/"></cms-nav>
            </header>

            <div id="navWrap" data-fw="true">
                <cms-path id="path"></cms-path>
                <cms-dir-nav id="secondaryNav"></cms-dir-nav>
            </div>

            <cms-index id="nodeIndex"
                       data-dir-ref="desc"></cms-index>

            <cms-node id="content" data-dir-ref="index"></cms-node>

            <footer>BGMRPC - BGCMS - BGPF</footer>
        </pf-page>

        <script data-fn="openNode" data-args="path">
            $(document).scrollTop(0);

            this.page.content.$.css("opacity", 0);
            this.page.nodeIndex.$.css("opacity", 0);
            this.page.path.$.css("opacity", 0);
            this.page.secondaryNav.$.css("opacity", 0);

            this.page.content.load(path).then(() => {
                this.style_framework.backtrackLoad("site/style/framework", path);
                this.style_page.backtrackLoad("site/style/page", path);
                this.style_colorScheme.backtrackLoad("site/style/colorScheme", path);
                this.page.content.$.css("opacity", 1);
                return Promise.resolve(this.page.content.node);
            }).then((node) => {
                this.node = node;

                //this.page.nodeIndex.switch(this.node.id == null || this.node.type == "D");

                if (this.node.id == CMS.homePath) {
                    this.page.$.attr('data-type', "H");
                    this.page.nodeIndex.$.addClass("flow-grid");
                    return Promise.resolve(CMS.rootNode);
                } else if (this.node.type == 'D') {
                    this.page.$.attr('data-type', "D");
                    this.page.nodeIndex.$.addClass("flow-grid");
                    return Promise.resolve(node);
                } else {
                    this.page.$.attr('data-type', "C");
                    this.page.nodeIndex.$.removeClass("flow-grid");
                    return CMS.node(node.pid);
                }
            }, null).then((node) => {
                if (this.currentDirID != node.id) {
                    this.currentDirID = node.id;

                    var pm = node.id == CMS.rootNode.id
                        ? this.page.nodeIndex.search({
                            "limit": { "count": 25 },
                             "type": "F"
                        })
                        : this.page.nodeIndex.load(this.currentDirID);

                    pm.then(()=> {
                        this.page.nodeIndex.$.css("opacity", 1);
                    });

                    this.page.path.load(node.id).then(() => {
                        this.page.path.$.css("opacity", 1);
                    });
                } else {
                    this.page.nodeIndex.$.css("opacity", 1);
                    this.page.path.$.css("opacity", 1);
                }

                var pDir = node.pid;
                if (this.parentDirID != pDir) {
                    this.parentDirID = pDir;
                    return Promise.resolve(this.parentDirID);
                } else
                    return Promise.resolve();
            }).then((dirPath) => {
                if (dirPath !== undefined) {
                    return this.page.secondaryNav.load(dirPath);
                } else
                    return Promise.resolve();
            }).then(() => {
                this.page.secondaryNav.$.css("opacity", 1);
                this.page.secondaryNav.activate(this.currentDirID);
            });
        </script>

        <script data-fn="constructor">
            this.parentDirID = -1;
            this.currentDirID = -1;
            /*this.style.load("/site/style/default").then(null, () => {
                    this.style.$.replaceWith('<link rel="stylesheet" href="cms/Components/defaultFramework.css">');
                });*/

            RPCCONN.on("ping", () => {
                this.$.attr("data-pingpong", 0);
            });
            RPCCONN.on("pong", () => {
                this.$.attr("data-pingpong", 1);
            });
            RPCCONN.on("connected", () => {
                this.$.attr("data-connected", "");
            });
            RPCCONN.on("disconnected", () => {
                this.$.removeAttr("data-connected");
            });
        </script>
    </pf-body>

</pf-package>

