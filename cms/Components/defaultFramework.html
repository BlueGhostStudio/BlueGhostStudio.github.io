<pf-package>
    <script data-fn="load" data-args="relPath, nextLoad">
        nextLoad();
    </script>

    <pf-body data-ft="cms::default::framework" data-connected data-fns="body::root" data-tagName="body">
        <cms-style data-fn="style_framework" data-backtrack data-style="site/style/framework">
            <script data-fn="backtrackLoad" data-args="path, basePath">
                this.superTmpl("cms::style").backtrackLoad.call(this, path, basePath).then(() => {
                    return Promise.resolve();
                }, () => {
                    return Promise.resolve();
                }).then(() => {
                    this.toNS("body::root").$.addClass("style_framework_actived");
                });
            </script>
        </cms-style>
        <cms-style data-fn="style_page" data-backtrack data-style="site/style/page">
            <script data-fn="backtrackLoad" data-args="path, basePath">
                this.superTmpl("cms::style").backtrackLoad.call(this, path, basePath).then(() => {
                    return Promise.resolve();
                }, () => {
                    return Promise.resolve();
                }).then(() => {
                    this.toNS("body::root").$.addClass("style_page_actived");
                });
            </script>
        </cms-style>
        <cms-style data-fn="style_colorScheme" data-backtrack data-style="site/style/colorScheme">
            <script data-fn="backtrackLoad" data-args="path, basePath">
                this.superTmpl("cms::style").backtrackLoad.call(this, path, basePath).then(() => {
                    return Promise.resolve();
                }, () => {
                    return Promise.resolve();
                }).then(() => {
                    this.toNS("body::root").$.addClass("style_colorscheme_actived");
                });
            </script>
        </cms-style>

        <pf-page data-fn="page">
            <header data-fw="true">
                <!-- <cms-img id="logo" src="/site/logo"></cms-img> -->
                <cms-img-div id="logo" data-src="site/logo" data-backtrack></cms-img-div>
                <cms-site-title id="siteTitle"></cms-site-title>
                <cms-nav id="mainNav" data-path="/"></cms-nav>
            </header>

            <div id="navWrap" data-fw="true">
                <cms-path id="path">
                    <script data-fn="constructor">
                        this.superTmpl("cms::path").constructor.call(this);

                        CMSCONN.on("currentNodeChanged", () => {
                            this.$.css("display", "none");
                            this.load(this.toNS("body::root").currentDirID).then(() => {
                                this.$.css("display", "");
                            });
                        }, this);
                    </script>
                </cms-path>
                <cms-dir-nav id="secondaryNav">
                    <script data-fn="constructor">
                        this.superTmpl("cms::dir::nav").constructor.call(this);

                        CMSCONN.on("currentNodeChanged", () => {
                            var bodyRoot = this.toNS("body::root");
                            
                            var pDirID = bodyRoot.parentDirID;
                            if (this.listNode != pDirID) {
                                this.$.css("display", "none");
                                this.load(pDirID).then(() => {
                                    this.activate(bodyRoot.currentDirID);
                                    this.$.css("display", "");
                                });
                            } else
                                this.activate(bodyRoot.currentDirID);
                        }, this);
                    </script>
                </cms-dir-nav>
            </div>

            <cms-index id="nodeIndex"
                       data-dir-ref="desc">
                <script data-fn="constructor">
                    this.superTmpl("cms::index").constructor.call(this);

                    CMSCONN.on("currentNodeChanged", (dirNode) => {
                        this.$.css("display", "none");
                        (dirNode.id === CMS.rootNode.id
                            ? this.search({
                                "limit": { "count": 25 },
                                "type": "F"
                            })
                            : this.load(this.toNS("body::root").currentDirID)).then(() => {
                                this.$.css("display", "");
                            });
                    });
                </script>
            </cms-index>

            <cms-node id="content" data-dir-ref="index">
                <script data-fn="constructor">
                    this.superTmpl("cms::node").constructor.call(this);

                    CMSCONN.on("currentNodeChanged", () => {
                        this.$.css("display", "none");
                        this.load(CMS.currentNode).then(() => {
                            this.$.css("display", "");
                        });
                    }, this);
                </script>
            </cms-node>

            <footer>BGMRPC - BGCMS - BGPF</footer>
        </pf-page>

        <script data-fn="openNode" data-args="path">
            $(document).scrollTop(0);

            this.$.removeClass("style_framework_actived");
            this.$.removeClass("style_page_actived");
            this.$.removeClass("style_colorscheme_actived");
            CMS.node(path).then((node) => {
                CMS.currentNode = node;
                if (CMS.currentNode.id == CMS.homePath) {
                    this.page.$.attr('data-type', 'H');
                    this.page.nodeIndex.$.addClass("flow-grid");
                    return Promise.resolve(CMS.rootNode);
                } else if (CMS.currentNode.type == 'D') {
                    this.page.$.attr('data-type', "D");
                    this.page.nodeIndex.$.addClass("flow-grid");
                    return Promise.resolve(CMS.currentNode);
                } else {
                    this.page.$.attr('data-type', "C");
                    this.page.nodeIndex.$.removeClass("flow-grid");
                    return CMS.node(CMS.currentNode.pid);
                }
            }).then((node) => {
                if (this.currentDirID != node.id)
                    this.currentDirID = node.id;
                if (this.parentDirID != node.pid)
                    this.parentDirID = node.pid;

                CMSCONN.emit("currentNodeChanged", node);
            });

        </script>

        <script data-fn="constructor">
            this.parentDirID = -1;
            this.currentDirID = -1;
            /*this.style.load("/site/style/default").then(null, () => {
                    this.style.$.replaceWith('<link rel="stylesheet" href="cms/Components/defaultFramework.css">');
                });*/

            RPCCONN.on("connected", () => {
                this.$.attr("data-connected", "");
            });
            RPCCONN.on("disconnected", () => {
                this.$.removeAttr("data-connected");
            });
        </script>
    </pf-body>

</pf-package>

