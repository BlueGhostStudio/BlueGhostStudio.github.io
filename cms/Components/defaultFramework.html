<pf-package>
    <script data-fn="load" data-args="relPath, nextLoad">
        nextLoad();
    </script>

    <pf-body data-ft="cms::default::framework" data-connected data-fns="body::root" data-tagName="body">
        <cms-style data-fn="style_framework" data-backtrack></cms-style>
        <cms-style data-fn="style_page" data-backtrack></cms-style>
        <cms-style data-fn="style_colorScheme" data-backtrack></cms-style>

        <pf-page data-fn="page">
            <header data-fw="true">
                <!-- <cms-img id="logo" src="/site/logo"></cms-img> -->
                <cms-img-div id="logo" data-backtrack></cms-img-div>
                <cms-site-title id="siteTitle"></cms-site-title>
                <cms-nav id="mainNav" data-path="/"></cms-nav>
            </header>

            <div id="navWrap" data-fw="true">
                <cms-path id="path"></cms-path>
                <cms-dir-nav id="secondaryNav"></cms-dir-nav>
            </div>

            <cms-index id="nodeIndex" data-dir-ref="desc"></cms-index>

            <cms-node id="content" data-dir-ref="index"></cms-node>

            <footer>BGMRPC - BGCMS - BGPF</footer>
        </pf-page>

        <script data-fn="openNode" data-args="path">
            $(document).scrollTop(0);

            this.$.removeClass("style_framework_actived");
            this.$.removeClass("style_page_actived");
            this.$.removeClass("style_colorscheme_actived");
            CMS.node(path).then((node) => {
                CMS.currentNode = node;
                if (CMS.currentNode.id == CMS.homePath) {
                    this.page.$.attr('data-type', 'H');
                    this.page.nodeIndex.$.addClass("flow-grid");
                    return Promise.resolve(CMS.rootNode);
                } else if (CMS.currentNode.type == 'D') {
                    this.page.$.attr('data-type', "D");
                    this.page.nodeIndex.$.addClass("flow-grid");
                    return Promise.resolve(CMS.currentNode);
                } else {
                    this.page.$.attr('data-type', "C");
                    this.page.nodeIndex.$.removeClass("flow-grid");
                    return CMS.node(CMS.currentNode.pid);
                }
            }).then((node) => {
                if (this.currentDirID != node.id)
                    this.currentDirID = node.id;
                if (this.parentDirID != node.pid)
                    this.parentDirID = node.pid;

                CMSCONN.emit("currentNodeChanged", node);
            });

        </script>

        <script data-fn="constructor">
            this.parentDirID = -1;
            this.currentDirID = -1;
            /*this.style.load("/site/style/default").then(null, () => {
                    this.style.$.replaceWith('<link rel="stylesheet" href="cms/Components/defaultFramework.css">');
                });*/

            RPCCONN.on("connected", () => {
                this.$.attr("data-connected", "");
            });
            RPCCONN.on("disconnected", () => {
                this.$.removeAttr("data-connected");
            });


            var waitLoadStyle = (styleObj, sPath, actived) => {
                CMSCONN.on("currentNodeChanged", () => {
                    styleObj.backtrackLoad(sPath).then(() => {
                        return Promise.resolve();
                    }, () => {
                        return Promise.resolve();
                    }).then(() => {
                        this.$.addClass(actived);
                        CMSCONN.emit("styleLoaded", actived);
                    });
                }, styleObj);
            }

            waitLoadStyle(this.style_framework, "site/style/framework", "style_framework_actived");
            waitLoadStyle(this.style_page, "site/style/page", "style_page_actived");
            waitLoadStyle(this.style_colorScheme, "site/style/colorScheme", "style_colorscheme_actived");

            CMSCONN.on("currentNodeChanged", () => {
                this.page.logo.load("site/logo").then(() => {
                    CMSCONN.emit("logoLoaded");
                });
            }, this.page.logo);

            CMSCONN.on("currentNodeChanged", () => {
                this.page.path.$.css("display", "none");
                this.page.path.load(this.currentDirID).then(() => {
                    this.page.path.$.css("display", "");
                    CMSCONN.emit("pathLoaded");
                });
            }, this.page.path);

            CMSCONN.on("currentNodeChanged", () => {
                if (this.page.secondaryNav.listNode != this.parentDirID) {
                    this.page.secondaryNav.$.css("display", "none");
                    this.page.secondaryNav.load(this.parentDirID).then(() => {
                        this.page.secondaryNav.activate(this.currentDirID);
                        this.page.secondaryNav.$.css("display", "");
                        CMSCONN.emit("secondaryNavLoaded");
                    });
                } else
                    this.page.secondaryNav.activate(this.currentDirID);
            }, this.page.secondaryNav);

            CMSCONN.on("currentNodeChanged", (dirNode) => {
                this.page.nodeIndex.$.css("display", "none");
                (dirNode.id === CMS.rootNode.id
                    ? this.page.nodeIndex.search({
                        "limit": { "count": 25 },
                        "type": "F"
                    })
                    : this.page.nodeIndex.load(this.currentDirID)).then(() => {
                        this.page.nodeIndex.$.css("display", "");
                        CMSCONN.emit("nodeIndexLoaded");
                    });
            }, this.page.nodeIndex);

            CMSCONN.on("currentNodeChanged", () => {
                this.page.content.$.css("display", "none");
                this.page.content.load(CMS.currentNode).then(() => {
                    this.page.content.$.css("display", "");
                    CMSCONN.emit("contentLoaded");
                });
            }, this.page.content);
        </script>
    </pf-body>

</pf-package>

