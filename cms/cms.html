<pf-package>
    <script data-fn="load" data-args="relPath, nextLoad">
        window.CMS = this;
        window.__body__ = compile($('body'));

        this.currentSiteFramework = null;
        this.rootNode = this.fraRootNode = {
            pid: null,
            id: null,
            title: '/',
            type: 'D'
        }
        this.currentNode = this.rootNode;

        __PF_BASE_CLASS__.prototype.html = function (h) {
            if (h !== undefined) {
                this.$.html(h);
                this.$.find("a").click((ev) => {
                    var href = $(ev.target).attr("href");
                    if (/^\?(p|id)=/.test(href)) {
                        CMS.open(href.replace(/\?(p|id)=/, ''));
                        return false;
                    } else
                        return true;
                });
            }
            return this.$.html();
        }

        loadModules([
            relPath + "../BGTmpls/BGTmpls.html",
            relPath + "../BGTmpls/RPC.html",
            relPath + "Components/content.html",
            relPath + "Components/node.html",
            relPath + "Components/list.html",
            relPath + "Components/nav.html",
            relPath + "Components/mis.html",
            relPath + "Components/defaultFramework.html"
        ], false).onEnd(() => {
            compile($('<pf-connections id="CMSCONN" data-global></pf-connections>'));

            var qsa = __queryStringArray__(location.href);
            if (qsa.g)
                CMS.RPCGRP = qsa.g;

            RPCCONN.on("connected", () => {
                rpc.asyncCall(this.RPCOBJ("cms::main"), "join");
            });

            RPCCONN.on("remoteSignal", (args) => {
                if (args[0] == this.RPCOBJ("cms::main"))
                    CMSCONN.emit(args[1], args[2]);
            });

            /*rpc.onRemoteSignal((ev, obj, sig, args) => {
                if (obj == this.RPCOBJ("cms::main"))
                    CMSCONN.emit(sig, args);
            });

            rpc.onDisconnected = () => {
                if (this.pingTimeoutID !== undefined)
                    clearTimeout(this.pingTimeoutID);
                if (this.pingIntervalID !== undefined)
                    clearTimeout(this.pingIntervalID);
                console.log("---------- onDisconnected ------------");
                rpc.connect();
            }

            rpc.onConnected = () => {
                if (this.pingTimeoutID !== undefined)
                    clearTimeout(this.pingTimeoutID);
                if (this.pingIntervalID !== undefined)
                    clearTimeout(this.pingIntervalID);

                rpc.asyncCall(this.RPCOBJ("cms::main"), "join").then(() => {
                    this.ping();
                    CMSCONN.emit("connected");
                });
            }*/

            nextLoad();
        });
        $("head").append('<link type="text/css" rel="stylesheet" href="'
            + relPath + 'cms.css">');

        CMS.homePath = null;
    </script>

    <script data-fn="RPCOBJ" data-args="obj">
        return (this.RPCGRP ? this.RPCGRP + "::" : "") + obj;
    </script>

    <script data-fn="search" data-args="query">
        return rpc.asyncCall(this.RPCOBJ("cms::main"), "search", query, 0x03)
            .then((ret) => {
                return Promise.resolve(ret);
            });
    </script>

    <script data-fn="list" data-args="pNode, query">
        return rpc.asyncCall(this.RPCOBJ("cms::main"), "list", pNode, 0x03, query)
            .then((ret) => {
                return Promise.resolve(ret);
            });
    </script>

    <script data-fn="nodeInfo" data-args="node, pNode">
        if (!isNaN(node))
            node = Number(node);

        return (pNode !== undefined
            ? rpc.asyncCall(this.RPCOBJ("cms::main"), "refNodeInfo", pNode, node)
            : rpc.asyncCall(this.RPCOBJ("cms::main"), "refNodeInfo", node))
            .then((ret) => {
                if (ret.ok)
                    return Promise.resolve(ret.node);
                else
                    return Promise.reject(ret.error);
            });
    </script>

    <script data-fn="node" data-args="node, pNode">
        if (!isNaN(node))
            node = Number(node);

        return (pNode !== undefined
            ? rpc.asyncCall(this.RPCOBJ("cms::main"), "refNode", pNode, node)
            : rpc.asyncCall(this.RPCOBJ("cms::main"), "refNode", node))
            .then((ret) => {
                if (ret.ok)
                    return Promise.resolve(ret.node);
                else
                    return Promise.reject(ret.error);
            });
    </script>

    <script data-fn="nodePath" data-args="node">
        if (!isNaN(node))
            node = Number(node);

        return rpc.asyncCall(this.RPCOBJ("cms::main"), "nodePath", node)
            .then((ret) => {
                if (ret.str.length > 0)
                    return Promise.resolve(ret);
                else
                    return Promise.reject(false);
            });
    </script>

    <script data-fn="loadComponent" data-args="node, pNode">
        return this.node(node, pNode).then((ret) => {
            var package = compile($(ret.content));
            return package.load();
        }, (ret) => {
            return Promise.reject(ret);
        });
    </script>

    <script data-fn="renderStyle" data-args="node, pNode, option">
        return this.node(node, pNode).then((ret) => {
            return less.render(ret.content, option).then((output) => {
                return Promise.resolve({ id: ret.id, css: output.css });
            });
        }, (ret) => { return Promise.reject(ret); });
    </script>

    <script data-fn="backtrackNode" data-args="node, target, stop">
        if (node !== undefined || node !== null)
            node = this.currentNode.id;
        else if (!isNaN(node))
            node = Number(node);

        return rpc.asyncCall(this.RPCOBJ("cms::web"),  "backtrackNode", node, target, stop)
            .then((ret) => {
                if (ret.ok)
                    return Promise.resolve(ret);
                else
                    return Promise.reject(ret);
            });
    </script>

    <script data-fn="mediaUrl" data-args="media">
        return rpc.asyncCall(this.RPCOBJ("cms::media"), "mediaURL", media)
            .then((ret) => {
                return Promise.resolve(ret);
            });
    </script>

    <script data-fn="addStyle" data-args="path, targetHtml">
        return this.renderStyle(path)
            .then((ret) => {
                var style = '<style>' + ret.css + '</style>';
                if (targetHtml !== undefined)
                    targetHtml.$.append(style);
                else
                    $('head').append(style);

                return Promise.resolve(ret.id);
                }, (ret) => {
                    Promise.reject(ret);
                });
    </script>

    <script data-fn="replaceBody" data-args="tmpl">
        if ('removeSelf' in __body__)
            __body__.removeSelf();

        __body__ = this.create(tmpl);

        $('html').append(__body__.$);
    </script>

    <script data-fn="loadSiteFramework" data-args="path">
        if (path == undefined || path.length == 0)
            path = '/';
        
        return this.backtrackNode(path, 'site/framework.fra')
            .then((ret) => {
                var tID = ret.target.id;
                if (this.currentSiteFramework != tID) {
                    this.currentSiteFramework = tID;
                    this.fraRootNode = ret.node;

                    return this.loadComponent(tID).then(() => {
                        return Promise.resolve(path);
                    });
                } else
                    return Promise.resolve(path);
            },(ret) => {
                if (ret.errno == 0) {
                    if (this.currentSiteFramework != -1) {
                        this.currentSiteFramework = -1;
                        this.fraRootNode = CMS.rootNode;
                        this.replaceBody('cms::default::framework');
                    }
                    return Promise.resolve(path);
                } else
                    return Promise.reject(ret.error);
            });
    </script>

    <script data-fn="open" data-args="path">
        if (path == '/'|| path == null || (path instanceof Object && path.id == null))
            path = CMS.homePath;

        //CMSCONN.emit("openNode", []);
        return CMS.loadSiteFramework(path).then((ret) => {
                if ("openNode" in __body__)
                    __body__.openNode(ret);
                else
                    console.log("No openNode method");
            });
    </script>

    <script data-fn="connect" data-args="ip, port, path">
        rpc.connect(ip, port);
        return new Promise(resolve => {
            RPCCONN.on("connected", () => {
                resolve();
            });
        });
    </script>

    <script data-fn="initial">
        var qsa = __queryStringArray__(location.href);

        CMS.loadComponent('/site/components.pkg').then(null, (ret) => {
            console.log('error', ret);
        }).then(() => {
            return CMS.loadComponent('/site/global').then(() => {
                if (CMS.homePath !== null) {
                    return CMS.node(CMS.homePath).then((node) => {
                        CMS.homePath = node.id;
                    }, (ret) => {
                        console.log('no exist home path');
                        CMS.homePath = null;
                    });
                }
            }, (ret) => { console.log('no global'); });
        }).then(() => {
            if (qsa.id)
                CMS.open(qsa.id);
            else if (qsa.p)
                CMS.open(qsa.p);
            else
                CMS.open(CMS.homePath);
        });
    </script>

</pf-package>
