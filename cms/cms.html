<pf-package>
    <script data-fn="load" data-args="relPath, nextLoad">
        window.CMS = this;
        window.__body__ = compile($('body'));
        loadModules([
            relPath + "../BGTmpls/BGTmpls.html",
            relPath + "../BGTmpls/RPC.html"
        ], false).onEnd(() => {
            compile($('<pf-connections id="CMSCONN" data-global></pf-connections>'));
            rpc.onRemoteSignal = (obj, sig, args) => {
                if (obj === "cms::main") {
                    CMSCONN.emit(sig, args);
                }
            };
            nextLoad();
        });
        $("head").append('<link type="text/css" rel="stylesheet" href="'
            + relPath + 'cms.css">');
    </script>

    <pf-package>
        <pf-body data-ft="defaultBodyTmpl" data-tagName="body">
            <p>No site's framework</p>
        </pf-body>
    </pf-package>

    <script data-fn="list" data-args="pNode">
        return rpc.asyncCall("cms::main", "list", pNode, 0x03)
            .then((ret) => {
                return Promise.resolve(ret);
            });
    </script>

    <script data-fn="nodeInfo" data-args="node, pNode">
        return (pNode !== undefined
            ? rpc.asyncCall("cms::main", "nodeInfo", pNode, node)
            : rpc.asyncCall("cms::main", "nodeInfo", node))
            .then((ret) => {
                if (ret.ok)
                    return Promise.resolve(ret.node);
                else
                    return Promise.reject(false);
            });
    </script>

    <script data-fn="node" data-args="node, pNode">
        if (!isNaN(node))
            node = Number(node);

        return (pNode !== undefined
            ? rpc.asyncCall("cms::main", "node", pNode, node)
            : rpc.asyncCall("cms::main", "node", node))
            .then((ret) => {
                if (ret.ok)
                    return Promise.resolve(ret.node);
                else
                    return Promise.reject(ret.error);
            });
    </script>

    <script data-fn="nodePath" data-args="node">
        if (!isNaN(node))
            node = Number(node);

        return rpc.asyncCall("cms::main", "nodePath", node)
            .then((ret) => {
                if (ret.src.length > 0)
                    return Promise.resolve(ret.str);
                else
                    return Promise.reject(false);
            });
    </script>

    <script data-fn="loadComponent" data-args="node, pNode">
        return this.node(node, pNode).then((ret) => {
            var package = compile($(ret.content));
            return package.load();
        }, (ret) => {
            return Promise.reject(ret);
        });
    </script>

    <script data-fn="renderStyle" data-args="node, pNode">
        return this.node(node, pNode).then((ret) => {
            return less.render(ret.content).then((output) => {
                return Promise.resolve({ id: ret.id, css: output.css });
            });
        }, (ret) => { return Promise.reject(ret); });
    </script>

    <script data-fn="traverse" data-args="node, target">
        if (!isNaN(node))
            node = Number(node);

        return rpc.asyncCall("cms::web", "traverse", node, target)
            .then((ret) => {
                if (ret.ok)
                    return Promise.resolve(ret);
                else
                    return Promise.reject(ret.error);
            });
    </script>

    <script data-fn="mediaUrl" data-args="media">
        return rpc.asyncCall("cms::media", "mediaURL", media)
            .then((ret) => {
                return Promise.resolve(ret);
            });
    </script>

    <script data-fn="addStyle" data-args="path, targetHtml">
        return this.renderStyle(path)
            .then((ret) => {
                var style = '<style>' + ret.css + '</style>';
                if (targetHtml !== undefined)
                    targetHtml.$.append(style);
                else
                    $('header').append(style);

                return Promise.resolve(ret.id);
                }, (ret) => {
                    Promise.reject(ret);
                });
    </script>

    <script data-fn="replaceBody" data-args="tmpl">
        if ('removeSelf' in __body__)
            __body__.removeSelf();

        __body__ = this.create(tmpl);

        $('html').append(__body__.$);
    </script>

    <script data-fn="loadSiteFramework" data-args="path">
        if (path == undefined)
            path = '/';
        return this.traverse(path, 'site/framework.fra')
            .then((ret) => {
                var tID = ret.target.id;
                if (this.currentSiteFramework != tID) {
                    this.currentSiteFramework = tID;
                    this.rootNode = ret.node;

                    return this.loadComponent(tID).then(() => {
                        return Promise.resolve(path);
                    });
                } else
                    return Promise.resolve(path);
            },(ret) => {
                this.replaceBody('defaultBodyTmpl');
                return Promise.resolve(path);
            });
    </script>

    <script data-fn="open" data-args="path">
        return CMS.loadSiteFramework(path).then((ret) => {
                if ("openNode" in __body__)
                    __body__.openNode(ret);
                else
                    console.log("No openNode method");
            });
    </script>

    <script data-fn="connect" data-args="ip, port, path">
        rpc.connect(ip, port);
        return new Promise(resolve => {
            rpc.onConnected = () => {
                rpc.asyncCall("cms::main", "join")
                    .then(() => {
                        resolve();
                    });
            }
        });
    </script>

    <script data-fn="constructor">
        this.currentSiteFramework = null;
        this.rootNode = null;
    </script>

</pf-package>
