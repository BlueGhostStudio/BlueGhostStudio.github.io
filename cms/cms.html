<pf-package>
    <script data-fn="load" data-args="relPath, nextLoad">
        window.CMS = this;
        window.__body__ = compile($('body'));
        loadModules([
            relPath + "../BGTmpls/BGTmpls.html",
            relPath + "../BGTmpls/RPC.html"
        ], false).onEnd(() => {
            compile($('<pf-connections id="CMSCONN"></pf-connections>'));
            rpc.onRemoteSignal = (obj, sig, args) => {
                if (obj === "CMS") {
                    console.log("CMS.....")
                    CMSCONN.emit(sig, args);
                }
            };
            nextLoad();
        });
        $("head").append('<link type="text/css" rel="stylesheet" href="'
            + relPath + 'cms.css">');
    </script>

    <pf-package>
        <pf-body data-ft="defaultBodyTmpl" data-tagName="body">
            <p>No site's framework</p>
        </pf-body>
    </pf-package>

    <script data-fn="list" data-args="pNode">
        return rpc.asyncCall("cms::main", "list", pNode, 0x03)
            .then((ret) => {
                return Promise.resolve(ret);
            });
    </script>

    <script data-fn="nodeInfo" data-args="node">
        return rpc.asyncCall("cms::main", "nodeInfo", node)
            .then((ret) => {
                if (ret.ok)
                    return Promise.resolve(ret.node);
                else
                    return Promise.reject(false);
            });
    </script>

    <script data-fn="node" data-args="node">
        return rpc.asyncCall("cms::main", "node", node)
            .then((ret) => {
                if (ret.ok)
                    return Promise.resolve(ret.node);
                else
                    return Promise.reject(ret.error);
            });
    </script>

    <script data-fn="nodePath" data-args="node">
        return rpc.asyncCall("cms::main", "nodePath", node)
            .then((ret) => {
                if (ret.src.length > 0)
                    return Promise.resolve(ret.str);
                else
                    return Promise.reject(false);
            });
    </script>

    <script data-fn="loadComponent" data-args="node">
        return this.node(node).then((ret) => {
            var package = compile($(ret.content));
            return package.load();
        }, (ret) => {
            return Promise.reject(ret);
        });
    </script>

    <script data-fn="renderStyle" data-args="node">
        return this.node(node).then((ret) => {
            return less.render(ret.content).then((output) => {
                return Promise.resolve({ id: ret.id, css: output.css });
            });
        }, (ret) => { return Promise.reject(ret); });
    </script>

    <script data-fn="traverse" data-args="node, target">
        return rpc.asyncCall("cms::web", "traverse", node, target)
            .then((ret) => {
                if (ret.ok)
                    return Promise.resolve(ret.node);
                else
                    return Promise.reject(ret.error);
            });
    </script>

    <script data-fn="addStyle" data-args="path, target">
        return this.renderStyle(path)
            .then((ret) => {
                var style = '<style>' + ret.css + '</style>';
                if (target !== undefined)
                    target.$.append(style);
                else
                    $('header').append(style);

                return Promise.resolve(ret.id);
                }, (ret) => {
                    Promise.reject(ret);
                });
    </script>

    <script data-fn="replaceBody" data-args="tmpl">
        if ('removeSelf' in __body__)
            __body__.removeSelf();

        __body__ = this.create(tmpl);

        $('html').append(__body__.$);
    </script>

    <script data-fn="loadSiteFramework" data-args="path">
        return this.traverse(path, 'site/framework.fra')
            .then((ret) => {
                if (this.currentSiteFramework != ret.id) {
                    this.currentSiteFramework = ret.id;
                    return this.loadComponent(ret.id)
                } else
                    return Promise.resolve();
            },(ret) => {
                this.replaceBody('defaultBodyTmpl');
            });
    </script>

    <script data-fn="connect" data-args="ip, port, path">
        rpc.connect(ip, port);
        return new Promise(resolve => {
            rpc.onConnected = () => {
                rpc.asyncCall("cms::main", "join")
                    .then(() => {
                        resolve();
                    });
            }
        });
    </script>

    <script data-fn="constructor">
        this.currentSiteFramework = null;
    </script>

</pf-package>
